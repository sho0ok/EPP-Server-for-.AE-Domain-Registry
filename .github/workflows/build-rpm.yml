name: Build RPM

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: rockylinux:9

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          dnf install -y rpm-build python3 python3-pip python3-devel gcc \
            openssl-devel libffi-devel libxml2-devel libxslt-devel

      - name: Create build directories
        run: |
          mkdir -p build/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p build/rpmbuild/SOURCES/{src,config,scripts,systemd,venv}

      - name: Copy source files
        run: |
          cp -r src/* build/rpmbuild/SOURCES/src/
          cp config/epp.yaml build/rpmbuild/SOURCES/config/
          cp config/logging.yaml build/rpmbuild/SOURCES/config/
          cp build/rpm/SCRIPTS/generate-certs.sh build/rpmbuild/SOURCES/scripts/
          cp build/rpm/SCRIPTS/epp-server-cli build/rpmbuild/SOURCES/scripts/
          cp build/rpm/SOURCES/systemd/epp-server.service build/rpmbuild/SOURCES/systemd/

      - name: Create virtual environment with dependencies
        run: |
          python3 -m venv build/rpmbuild/SOURCES/venv
          source build/rpmbuild/SOURCES/venv/bin/activate
          pip install --upgrade pip wheel
          pip install lxml oracledb cryptography pyyaml python-dateutil
          deactivate

      - name: Build RPM
        run: |
          cp build/rpm/SPECS/epp-server.spec build/rpmbuild/SPECS/
          rpmbuild --define "_topdir $PWD/build/rpmbuild" \
                   --define "_sourcedir $PWD/build/rpmbuild/SOURCES" \
                   -bb build/rpmbuild/SPECS/epp-server.spec

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: epp-server-rpm
          path: build/rpmbuild/RPMS/**/*.rpm

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: github.ref == 'refs/heads/main'
        with:
          tag_name: v1.0.0-${{ github.run_number }}
          name: EPP Server v1.0.0 (Build ${{ github.run_number }})
          files: build/rpmbuild/RPMS/**/*.rpm
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
